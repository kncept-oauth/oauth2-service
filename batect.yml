containers:
  java:
#    image: eclipse-temurin:11-alpine
    image: openjdk:17-alpine
    volumes:
      - local: .
        container: /simple-oidc
        options: cached
      - local: .gradle-cache-java
        container: /home/simple-oidc/.gradle
        options: cached
    working_directory: /simple-oidc
    run_as_current_user:
      enabled: true
      home_directory: /home/simple-oidc
  nodejs:
    image: node:current-alpine3.16
    volumes:
      - local: .
        container: /simple-oidc
        options: cached
    working_directory: /simple-oidc
    run_as_current_user:
      enabled: true
      home_directory: /home/simple-oidc

tasks:
  clean:
    description: Clean project
    run:
      container: java
      command: ./gradlew clean
  build:
    description: gradle build
    run:
      container: java
      command: ./gradlew build

  buildAws:
    description: Build java-11 zip file for aws
    run:
      container: java
      command: ./gradlew :aws-service:jarDist :aws-service:zipDist

  deployAws:
    description: Deploys to AWS using the CDK. N.B. you need to have sys props set
#    prerequisites:
#      - buildAws
    run:
      container: nodejs
      command: "'npm i && npm run cdk deploy OidcDockerLambda'"
      entrypoint: /bin/sh -c
      working_directory: /simple-oidc/aws-deploy
      environment:
        AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
        AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
        AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}
